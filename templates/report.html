<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACEP ISO 27001 Audit Report - {{ generated_at.strftime('%d/%m/%Y') }}</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            color: #333333;
        }
        
        .header-section {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            color: white;
            padding: 2rem 0;
        }
        
        .company-logo {
            font-size: 2rem;
            color: #00bfff;
            font-weight: bold;
        }
        
        .section-header {
            background: #f8f9fa;
            border-left: 4px solid #00bfff;
            padding: 1rem;
            margin: 2rem 0 1rem 0;
        }
        
        .stat-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #00bfff;
        }
        
        .compliance-bar {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .compliance-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .risk-high { background-color: #dc3545; color: white; }
        .risk-medium { background-color: #ffc107; color: black; }
        .risk-low { background-color: #28a745; color: white; }
        
        .control-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .status-compliant { background-color: #d4edda; color: #155724; }
        .status-non-compliant { background-color: #f8d7da; color: #721c24; }
        .status-not-applicable { background-color: #d1ecf1; color: #0c5460; }
        .status-not-assessed { background-color: #fff3cd; color: #856404; }
        
        @media print {
            .no-print { display: none !important; }
            .page-break { page-break-before: always; }
            body { font-size: 12px; }
            .stat-number { font-size: 1.5rem; }
        }
        
        .footer {
            border-top: 2px solid #00bfff;
            margin-top: 3rem;
            padding-top: 1rem;
            text-align: center;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                                    <div class="company-logo mb-2">
                    <i class="bi bi-shield-check me-2"></i>ACEP ISO 27001 Audit Report
                </div>
                    <h2 class="h4 mb-0">Information Security Management System Assessment</h2>
                    <p class="mb-0 opacity-75">ISO/IEC 27001:2022 Compliance Audit</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="bg-white bg-opacity-10 p-3 rounded">
                        <div><strong>Generated:</strong> {{ generated_at.strftime('%d/%m/%Y %H:%M') }}</div>
                        <div><strong>By:</strong> {{ generated_by }}</div>
                        <div><strong>Version:</strong> 1.0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Executive Summary -->
    <div class="container my-4">
        <div class="section-header">
            <h3 class="mb-0"><i class="bi bi-graph-up me-2"></i>Executive Summary</h3>
        </div>
        
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number">{{ total_controls }}</div>
                    <div class="text-muted">Total Controls</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number text-success">{{ compliant_controls }}</div>
                    <div class="text-muted">Compliant</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number text-danger">{{ non_compliant_controls }}</div>
                    <div class="text-muted">Non-Compliant</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number">{{ compliance_percentage }}%</div>
                    <div class="text-muted">Compliance Rate</div>
                </div>
            </div>
        </div>
        
        <!-- Compliance Progress -->
        <div class="row mt-4">
            <div class="col-12">
                <h5>Overall Compliance Status</h5>
                <div class="compliance-bar">
                    <div class="compliance-fill" style="width: {{ compliance_percentage }}%;">
                        {{ compliance_percentage }}% Compliant
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-3 text-center">
                        <span class="badge bg-success px-3 py-2">{{ compliant_controls }} Compliant</span>
                    </div>
                    <div class="col-md-3 text-center">
                        <span class="badge bg-danger px-3 py-2">{{ non_compliant_controls }} Non-Compliant</span>
                    </div>
                    <div class="col-md-3 text-center">
                        <span class="badge bg-info px-3 py-2">{{ not_applicable_controls }} Not Applicable</span>
                    </div>
                    <div class="col-md-3 text-center">
                        <span class="badge bg-warning px-3 py-2">{{ not_assessed_controls }} Not Assessed</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Control Assessment Details -->
    <div class="container my-4 page-break">
        <div class="section-header">
            <h3 class="mb-0"><i class="bi bi-list-check me-2"></i>Control Assessment Details</h3>
        </div>
        
        {% set control_categories = controls|groupby('category') %}
        {% for category, category_controls in control_categories %}
        <div class="mb-4">
            <h4 class="text-primary">{{ category }}</h4>
            <div class="table-responsive">
                <table class="table table-striped control-table">
                    <thead>
                        <tr>
                            <th style="width: 120px;">Control ID</th>
                            <th>Title</th>
                            <th style="width: 120px;">Status</th>
                            <th>Notes</th>
                            <th style="width: 120px;">Assessed By</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for control in category_controls %}
                        <tr class="{% if control.status == 'Compliant' %}status-compliant
                                   {% elif control.status == 'Not Compliant' %}status-non-compliant
                                   {% elif control.status == 'Not Applicable' %}status-not-applicable
                                   {% else %}status-not-assessed{% endif %}">
                            <td><strong>{{ control.control_id }}</strong></td>
                            <td>{{ control.title }}</td>
                            <td>
                                <span class="badge 
                                    {% if control.status == 'Compliant' %}bg-success
                                    {% elif control.status == 'Not Compliant' %}bg-danger
                                    {% elif control.status == 'Not Applicable' %}bg-info
                                    {% else %}bg-warning{% endif %}">
                                    {{ control.status }}
                                </span>
                            </td>
                            <td>{{ control.notes or '-' }}</td>
                            <td>{{ control.assessed_by or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Risk Assessment -->
    {% if risks %}
    <div class="container my-4 page-break">
        <div class="section-header">
            <h3 class="mb-0"><i class="bi bi-shield-exclamation me-2"></i>Risk Assessment</h3>
        </div>
        
        <!-- Risk Statistics -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-number text-danger">{{ risks|selectattr('risk_score', 'ge', 15)|list|length }}</div>
                    <div class="text-muted">High Risk (â‰¥15)</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-number text-warning">{{ risks|selectattr('risk_score', 'ge', 8)|selectattr('risk_score', 'lt', 15)|list|length }}</div>
                    <div class="text-muted">Medium Risk (8-14)</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-number text-success">{{ risks|selectattr('risk_score', 'lt', 8)|list|length }}</div>
                    <div class="text-muted">Low Risk (<8)</div>
                </div>
            </div>
        </div>
        
        <!-- Risk Register -->
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Risk</th>
                        <th style="width: 80px;">Likelihood</th>
                        <th style="width: 80px;">Impact</th>
                        <th style="width: 80px;">Score</th>
                        <th>Mitigation</th>
                        <th style="width: 120px;">Owner</th>
                        <th style="width: 100px;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for risk in risks %}
                    <tr>
                        <td>
                            <strong>{{ risk.title }}</strong>
                            {% if risk.description %}
                            <br><small class="text-muted">{{ risk.description }}</small>
                            {% endif %}
                        </td>
                        <td class="text-center">{{ risk.likelihood }}</td>
                        <td class="text-center">{{ risk.impact }}</td>
                        <td class="text-center">
                            <span class="badge {% if risk.risk_score >= 15 %}risk-high{% elif risk.risk_score >= 8 %}risk-medium{% else %}risk-low{% endif %}">
                                {{ risk.risk_score }}
                            </span>
                        </td>
                        <td>{{ risk.mitigation or '-' }}</td>
                        <td>{{ risk.owner or 'Unassigned' }}</td>
                        <td>
                            <span class="badge {% if risk.status == 'Closed' %}bg-success{% elif risk.status == 'In Progress' %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ risk.status }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    <!-- Evidence Summary -->
    <div class="container my-4 page-break">
        <div class="section-header">
            <h3 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Evidence Summary</h3>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="stat-card">
                    <div class="stat-number">{{ evidence_count }}</div>
                    <div class="text-muted">Evidence Files</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-card">
                    <div class="stat-number">{{ controls|selectattr('notes', 'defined')|selectattr('notes', 'ne', '')|list|length }}</div>
                    <div class="text-muted">Controls with Notes</div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Evidence Management:</strong> {{ evidence_count }} evidence files have been uploaded and linked to specific controls. 
            Evidence files are stored securely and can be accessed through the audit system for review and compliance verification.
        </div>
    </div>
    
    <!-- Recommendations -->
    <div class="container my-4">
        <div class="section-header">
            <h3 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Recommendations</h3>
        </div>
        
        {% if non_compliant_controls > 0 %}
        <div class="alert alert-warning">
            <h5><i class="bi bi-exclamation-triangle me-2"></i>Priority Actions Required</h5>
            <p>{{ non_compliant_controls }} control(s) are currently non-compliant and require immediate attention:</p>
            <ul>
                {% for control in controls if control.status == 'Not Compliant' %}
                <li><strong>{{ control.control_id }}</strong>: {{ control.title }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        {% if not_assessed_controls > 0 %}
        <div class="alert alert-info">
            <h5><i class="bi bi-clock me-2"></i>Pending Assessments</h5>
            <p>{{ not_assessed_controls }} control(s) have not been assessed yet. Complete the assessment process to achieve full audit coverage.</p>
        </div>
        {% endif %}
        
        <div class="alert alert-success">
            <h5><i class="bi bi-check-circle me-2"></i>Next Steps</h5>
            <ol>
                <li>Address all non-compliant controls with appropriate corrective actions</li>
                <li>Complete assessment of remaining controls</li>
                <li>Implement risk mitigation strategies for high-risk items</li>
                <li>Schedule regular review and update cycles</li>
                <li>Maintain evidence repository and documentation</li>
            </ol>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="container">
        <div class="footer">
            <p class="mb-1"><strong>ACEP ISO 27001 Audit Assistant</strong> - Created by A Chaitanya Eshwar Prasad</p>
            <p class="mb-0">
                Report generated on {{ generated_at.strftime('%d/%m/%Y at %H:%M') }} by {{ generated_by }}
                <br>
                <small>This report contains confidential information and should be handled according to your organization's information classification policy.</small>
            </p>
        </div>
    </div>
    
    <!-- Print Button -->
    <div class="no-print position-fixed bottom-0 end-0 m-3">
        <button class="btn btn-primary" onclick="window.print()">
            <i class="bi bi-printer me-1"></i>Print Report
        </button>
    </div>
</body>
</html>
